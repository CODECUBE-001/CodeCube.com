var __spreadArrays=this&&this.__spreadArrays||function(){for(var s=0,i=0,il=arguments.length;i<il;i++)s+=arguments[i].length;for(var r=Array(s),k=0,i=0;i<il;i++)for(var a=arguments[i],j=0,jl=a.length;j<jl;j++,k++)r[k]=a[j];return r},Agent=function(){function Agent(options){var ready,_this=this;this.timeOrigin=null,this.sendIntervalSize=null,this.hasSentPage=!1,this.entryHash={},this.endpoints=[],window.performance&&window.performance.getEntriesByType&&(this.options=Object.keys(Agent.defaults).reduce(function(result,key){return result[key]=options[key]||Agent.defaults[key],result},{}),this.timeOrigin=performance.timeOrigin||performance.timing.navigationStart,this.sendIntervalSize=this.options.monitorSelfCalls?2:1,this.manageResourceBuffer(),ready=function(){_this.webVitalsObserver=new WebVitalsObserver,setInterval(function(){return _this.send()},1e4),window.addEventListener("unload",function(event){_this.endpoints=_this.endpoints.concat(_this.getEndpointEntries());var payload=_this.getPayload();navigator.sendBeacon&&payload&&navigator.sendBeacon(_this.options.ingestUrl,JSON.stringify(payload))})},"complete"===document.readyState?ready():document.addEventListener("readystatechange",function(event){"complete"===document.readyState&&ready()}))}return Agent.prototype.getPageEntry=function(){var timings,entry=performance.getEntriesByType("navigation")[0],result=null;result=entry?{url:0===entry.name.indexOf("http")?entry.name:window.location.toString(),start:entry.startTime,duration:entry.duration,domInteractive:entry.domInteractive,dnsTime:entry.domainLookupEnd-entry.domainLookupStart,sslTime:entry.connectEnd-entry.connectStart,serverTime:entry.responseEnd-entry.requestStart,blockingAssetLoadTime:entry.domInteractive-entry.responseEnd,pageSize:entry.transferSize}:(timings=performance.timing,{url:window.location.toString(),start:0,duration:timings.domComplete-timings.navigationStart,domInteractive:timings.domInteractive-timings.navigationStart,dnsTime:timings.domainLookupEnd-timings.domainLookupStart,sslTime:timings.connectEnd-timings.connectStart,serverTime:timings.responseEnd-timings.requestStart,blockingAssetLoadTime:timings.domInteractive-timings.responseEnd});var cssCount=0,cssSize=0,jsCount=0,jsSize=0,imgCount=0,imgSize=0;return performance.getEntriesByType("resource").forEach(function(entry){entry.startTime>result.duration||("link"===entry.initiatorType&&(cssCount++,cssSize+=entry.transferSize||0),"script"===entry.initiatorType&&(jsCount++,jsSize+=entry.transferSize||0),"img"===entry.initiatorType&&(imgCount++,imgSize+=entry.transferSize||0))}),result.jsCount=jsCount,result.jsSize=jsSize,result.cssCount=cssCount,result.cssSize=cssSize,result.imgCount=imgCount,result.imgSize=imgSize,result},Agent.prototype.getEndpointEntries=function(){var _this=this,result=[];return performance.getEntriesByType("resource").forEach(function(entry){var entryKey;entry.duration<=0||(entryKey=entry.name+entry.startTime,_this.entryHash[entryKey]||!_this.options.monitorSelfCalls&&entry.name===_this.options.ingestUrl||(_this.entryHash[entryKey]=!0,"xmlhttprequest"!==entry.initiatorType&&"fetch"!==entry.initiatorType||result.push({url:entry.name,pageUrl:window.location.toString(),status:200,start:entry.startTime,duration:entry.duration,dnsTime:entry.domainLookupEnd-entry.domainLookupStart,sslTime:entry.connectEnd-entry.connectStart,serverTime:0<entry.requestStart?entry.responseEnd-entry.requestStart:entry.duration,transferSize:entry.transferSize,encodedBodySize:entry.encodedBodySize,decodedBodySize:entry.decodedBodySize})))}),result},Agent.prototype.getDevice=function(){try{if(/Mobi|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent))return"mobile"}catch(e){}return"desktop"},Agent.prototype.getPayload=function(){var pageUrl=null===(pageEntry=this.getPageEntry())||void 0===pageEntry?void 0:pageEntry.url,pageEntry=this.hasSentPage?null:pageEntry;this.hasSentPage=!0,this.endpoints=this.endpoints.concat(this.getEndpointEntries());var payload={token:this.options.token,timeOrigin:new Date(this.timeOrigin).toISOString(),timeSent:(new Date).toISOString(),device:this.getDevice(),page:pageEntry,endpoints:__spreadArrays(this.endpoints),vitals:this.webVitalsObserver.getVitals(pageUrl)};return payload.page||payload.endpoints.length>=this.sendIntervalSize||payload.vitals?(this.endpoints.length=0,payload):null},Agent.prototype.send=function(){var xhr,payload=this.getPayload();payload&&((xhr=new XMLHttpRequest).open("POST",this.options.ingestUrl),xhr.setRequestHeader("Content-Type","application/json"),xhr.send(JSON.stringify(payload)))},Agent.prototype.manageResourceBuffer=function(){var _this=this;performance.setResourceTimingBufferSize&&performance.setResourceTimingBufferSize(250);function handleResourceTimingBufferFullEvt(evt){_this.send(),performance.clearResourceTimings()}performance.addEventListener?performance.addEventListener("resourcetimingbufferfull",handleResourceTimingBufferFullEvt):performance.onresourcetimingbufferfull=handleResourceTimingBufferFullEvt},Agent.defaults={token:null,ingestUrl:"https://in.requestmetrics.com/v1",monitorSelfCalls:!1},Agent}(),WebVitalsObserver=function(){function WebVitalsObserver(){var _this=this;this.isUnloading=!1,this.isBackgroundTab=!1,this.cls=null,this.clsSent=!1,this.lcp=null,this.fid=null,this.handleLayoutShift=function(entry){entry.hadRecentInput||(_this.cls+=entry.value)},this.handleLargestPaint=function(entry){entry.startTime>_this.lcp&&(_this.lcp=entry.startTime)},this.handleFirstInput=function(entry){_this.fid=entry.processingStart-entry.startTime},window.addEventListener("pagehide",function(event){_this.isUnloading=!event.persisted}),this.isBackgroundTab="hidden"===document.visibilityState,document.addEventListener("visibilitychange",function(event){_this.isUnloading||(_this.isBackgroundTab=!0)},{once:!0}),this.layoutObserver=this.addPerformanceObserver("layout-shift",this.handleLayoutShift),this.layoutObserver&&(this.cls=0),this.largestPaintObserver=this.addPerformanceObserver("largest-contentful-paint",this.handleLargestPaint),this.largestPaintObserver&&(this.lcp=0),this.firstInputObserver=this.addPerformanceObserver("first-input",this.handleFirstInput)}return WebVitalsObserver.prototype.getVitals=function(url){if(this.isBackgroundTab)return null;var anyMetric=!1,resultVitals={url:url||window.location.toString()};return this.clsSent||null===this.cls||(anyMetric=!0,resultVitals.cls=parseFloat(this.cls.toFixed(5)),this.layoutObserver.disconnect(),this.cls=null,this.clsSent=!0),this.isUnloading&&null!==this.lcp&&0<this.lcp&&(anyMetric=!0,resultVitals.lcp=parseFloat(this.lcp.toFixed(5)),this.largestPaintObserver.disconnect(),this.lcp=null),this.isUnloading&&null!==this.fid&&(anyMetric=!0,resultVitals.fid=parseFloat(this.fid.toFixed(5)),this.firstInputObserver.disconnect(),this.fid=null),anyMetric?resultVitals:null},WebVitalsObserver.prototype.addPerformanceObserver=function(type,callback){try{if(0<=PerformanceObserver.supportedEntryTypes.indexOf(type)){var po=new PerformanceObserver(function(result){return result.getEntries().map(callback)});return po.observe({type:type,buffered:!0}),po}}catch(e){}},WebVitalsObserver}(),sdk={__agent:null,install:function(options){this.__agent?console.warn("Request Metrics is already installed."):options&&options.token?this.__agent=new Agent(options):console.error("You must provide a token to install Request Metrics.")}};window.RM=sdk,function(){var token,scriptEl=document.querySelector("[data-rm-token]");!scriptEl||(token=scriptEl.getAttribute("data-rm-token"))&&window.RM.install({token:token,ingestUrl:scriptEl.getAttribute("data-rm-ingest"),monitorSelfCalls:!!scriptEl.getAttribute("data-rm-monitor-self")})}();
//# sourceMappingURL=rm.js.map